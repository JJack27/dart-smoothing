import 'package:flutter_test/flutter_test.dart';
import 'package:linalg/linalg.dart';

import 'package:smoothing/smoothing.dart';

void main() {
  test('Testing sg_filter', () {
    SgFilter filter = new SgFilter(3, 11);
    List<double> x = [
      0.671497133608081,
      -1.20748692268504,
      0.717238651328839,
      1.63023528916473,
      0.488893770311789,
      1.03469300991786,
      0.726885133383238,
      -0.303440924786016,
      0.293871467096658,
      -0.787282803758638,
      0.888395631757642,
      -1.14707010696915,
      -1.06887045816803,
      -0.809498694424876,
      -2.94428416199490,
      1.43838029281510,
      0.325190539456198,
      -0.754928319169703,
      1.37029854009523,
      -1.71151641885370,
      -0.102242446085491,
      -0.241447041607358,
      0.319206739165502,
      0.312858596637428,
      -0.864879917324457,
      -0.0300512961962686,
      -0.164879019209038,
      0.627707287528727,
      1.09326566903948,
      1.10927329761440,
      -0.863652821988714,
      0.0773590911304249,
      -1.21411704361541,
      -1.11350074148676,
    ];


    // This is generated by matlab
    Matrix expectedKernel = new Matrix([
      [0.580419580419581,	0.377622377622378,	0.209790209790210,	0.0769230769230770,	-0.0209790209790209,	-0.0839160839160839,	-0.111888111888112,	-0.104895104895105,	-0.0629370629370629,	0.0139860139860140,	0.125874125874126],
      [0.377622377622378,	0.278321678321678,	0.193006993006993,	0.121678321678322,	0.0643356643356643,	0.0209790209790210,	-0.00839160839160838,	-0.0237762237762238,	-0.0251748251748251,	-0.0125874125874125,	0.0139860139860141],
      [0.209790209790210,	0.193006993006993,	0.173892773892774,	0.152447552447552,	0.128671328671329,	0.102564102564103,	0.0741258741258741,	0.0433566433566434,	0.0102564102564103,	-0.0251748251748251,	-0.0629370629370629],
      [0.0769230769230770,	0.121678321678322,	0.152447552447552,	0.169230769230769,	0.172027972027972,	0.160839160839161,	0.135664335664336,	0.0965034965034965,	0.0433566433566434,	-0.0237762237762237,	-0.104895104895105],
      [-0.0209790209790209,	0.0643356643356644,	0.128671328671329,	0.172027972027972,	0.194405594405594,	0.195804195804196,	0.176223776223776,	0.135664335664336,	0.0741258741258741,	-0.00839160839160838,	-0.111888111888112],
      [-0.0839160839160839,	0.0209790209790210,	0.102564102564103,	0.160839160839161,	0.195804195804196,	0.207459207459207,	0.195804195804196,	0.160839160839161,	0.102564102564103,	0.0209790209790210,	-0.0839160839160839],
      [-0.111888111888112,	-0.00839160839160838,	0.0741258741258741,	0.135664335664336,	0.176223776223776,	0.195804195804196,	0.194405594405594,	0.172027972027972,	0.128671328671329,	0.0643356643356644,	-0.0209790209790209],
      [-0.104895104895105,	-0.0237762237762237,	0.0433566433566434,	0.0965034965034965,	0.135664335664336,	0.160839160839161,	0.172027972027972,	0.169230769230769,	0.152447552447552,	0.121678321678322,	0.0769230769230770],
      [-0.0629370629370629,	-0.0251748251748251,	0.0102564102564103,	0.0433566433566434,	0.0741258741258741,	0.102564102564103,	0.128671328671329,	0.152447552447552,	0.173892773892774,	0.193006993006993,	0.209790209790210],
      [0.0139860139860141,	-0.0125874125874125,	-0.0251748251748251,	-0.0237762237762238,	-0.00839160839160838,	0.0209790209790210,	0.0643356643356643,	0.121678321678322,	0.193006993006993,	0.278321678321678,	0.377622377622378],
      [0.125874125874126,	0.0139860139860140,	-0.0629370629370629,	-0.104895104895105,	-0.111888111888112,	-0.0839160839160839,	-0.0209790209790209,	0.0769230769230770,	0.209790209790210,	0.377622377622378,	0.580419580419581]
    ]);

    // This is generated by matlab
    List<double> expectedResult = [
      -0.235332862019499,
      0.399654158420015,
      0.736934867299822,
      0.839962040985777,
      0.772188455843734,
      0.597066888239547,
      0.737607049828818,
      0.357614409641884,
      0.0146322617645098,
      0.0105604993651135,
      -0.687295890582283,
      -0.866446332864499,
      -0.766938038043258,
      -0.954410717729565,
      -0.545296181196441,
      -0.561070955670255,
      -0.218487524212231,
      -0.140167176960800,
      -0.0534334725288754,
      0.155446125513160,
      -0.306715058698973,
      -0.210649854737842,
      -0.218004007697386,
      -0.342474254910967,
      0.0117145115709038,
      0.187543547535985,
      0.267758606642191,
      0.391585162923060,
      0.429911431694899,
      0.404689003589112,
      0.235435179364381,
      -0.117160661707073,
      -0.692409140353028,
      -1.52962087730126,
    ];

    // static attributes
    expect(filter.order, 3);
    expect(filter.frameLength, 11);
    expect(filter.kernel, expectedKernel);


    List<double> result = filter.smooth(x);

    // tolerance test.
    for(int i = 5; i < expectedResult.length-5; i++){
      expect(result[i], moreOrLessEquals(expectedResult[i]));
    }

  });
}
